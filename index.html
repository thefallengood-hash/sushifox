<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sushi Fox — меню</title>
<link rel="icon" href="images/favicon.png" type="image/x-icon" />
<style>
:root{
  --bg:#2a2a2a;
  --accent:#f0630c;
  --muted:#98a0aa;
  --radius:14px;
  --shadow:0 12px 30px rgba(2,6,23,.45);
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:radial-gradient(900px 400px at -10% -10%, #ffeef6 0%, transparent 0%), radial-gradient(900px 500px at 110% -10%, #e8f7ff 0%, transparent 0%), var(--bg); color:#e6eef6; min-height:100dvh; -webkit-font-smoothing:antialiased;}
.container{max-width:1100px;margin:0 auto;padding:20px}
.header{display:flex;align-items:center;gap:12px;margin-bottom:18px}
.logo{width:56px;height:56px;border-radius:12px;background:url('images/323231231.png') center/cover no-repeat;box-shadow:var(--shadow)}
h1{margin:0;font-size:22px;color:var(--accent)}
.subtitle{color:var(--muted);font-size:13px}
.tabs{display:flex;gap:10px;flex-wrap:wrap;margin:18px 0}
.tab{padding:10px 14px;border-radius:999px;background:#fff;font-weight:600;color:#111;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,.08)}
.tab.active{background:linear-gradient(120deg,var(--accent),#ffb347);color:#fff}
.section{background:transparent;border-radius:var(--radius)}

/* Slider for product images */
.slider-container{max-width:420px;margin:0 auto;border-radius:var(--radius);overflow:hidden;background:#fff;box-shadow:var(--shadow)}
.slider-container img#mainSlide{width:100%;height:260px;object-fit:cover;display:block}
.slide{display:none}
.slide.active{display:block}
.slide img{width:100%;height:260px;object-fit:cover;display:block}
.thumbs-row{display:flex;align-items:center;gap:8px;margin-top:8px;justify-content:center;padding:8px}
#thumbs{display:flex;gap:6px;overflow:hidden}
#thumbs img{height:60px;width:100px;object-fit:cover;border-radius:10px;opacity:.65;cursor:pointer;transition:all .18s;border:2px solid transparent}
#thumbs img.active{opacity:1;box-shadow:0 0 0 3px rgba(255,153,0,.12);transform:translateY(-2px);border-color:var(--accent)}

/* Products grid */
.products{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-top:14px}
@media(max-width:980px){.products{grid-template-columns:repeat(3,1fr)}}
@media(max-width:720px){.products{grid-template-columns:repeat(2,1fr)}}
@media(max-width:460px){.products{grid-template-columns:repeat(1,1fr)}}

/* Card */
.card{
  background:#fff;
  border-radius:12px;
  overflow:hidden;
  box-shadow:0 10px 30px rgba(2,6,23,.06);
  display:flex;
  flex-direction:column;
  transition:transform .18s;
}
.card:hover{transform:translateY(-6px)}
.card-img{width:100%;height:160px;object-fit:cover;cursor:pointer}
.card-body{padding:12px;display:flex;flex-direction:column;gap:8px}
.card-title{font-weight:700;color:#0b1220;display:flex;align-items:center;gap:8px}
.card-desc{font-size:13px;color:var(--accent);min-height:36px}
.card-row{display:flex;align-items:center;justify-content:space-between;gap:8px}
.price{font-weight:700;color:var(--accent)}

/* Badge styles */
.badge { display:inline-block; padding:4px 8px; font-size:12px; border-radius:999px; font-weight:700; line-height:1; }
.badge-popular { background:#ff4d4f; color:#fff; }
.badge-new { background:#ffb347; color:#111; border:1px solid rgba(0,0,0,0.04); }

/* Buttons */
.btn{background:linear-gradient(120deg,var(--accent),#ffb347);color:#fff;padding:8px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
.btn:active{transform:translateY(1px)}

/* Cart FAB (плавающая кнопка) */
/* — добавлены cursor, user-select и touch-action для перетаскивания */
.cart-fab{
  position:fixed;
  right:18px;
  bottom:18px;
  width:64px;
  height:64px;
  border-radius:18px;
  background:linear-gradient(120deg,var(--accent),#ffb347);
  display:grid;
  place-items:center;
  color:#fff;
  font-weight:800;
  font-size:22px;
  cursor:grab;
  user-select:none;
  touch-action:none; /* важно для pointer events */
  box-shadow:var(--shadow);
  z-index:1101;
}
.cart-fab:active{ cursor:grabbing; }
.cart-count{position:absolute;top:-6px;right:-6px;background:#071023;color:#fff;border-radius:999px;padding:3px 7px;font-size:12px}

/* ========== SLIDE-IN CART PANEL ========== */
#cartOverlay{
  position:fixed; inset:0; background:rgba(2,6,23,.45);
  opacity:0; visibility:hidden; transition:opacity .25s;
  z-index:1100;
}
#cartOverlay.active{ opacity:1; visibility:visible; }

#cartPanel{
  position:fixed; top:0; right:-420px; width:380px; max-width:92vw; height:100%;
  background:#fff; color:#0b1220; box-shadow:-30px 0 60px rgba(2,6,23,.35);
  border-left: 1px solid rgba(0,0,0,.04);
  z-index:1101; transition:right .32s cubic-bezier(.2,.9,.2,1);
  display:flex; flex-direction:column; padding:18px; gap:12px;
}
#cartPanel.active{ right:0; }

#cartPanel .panel-header{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
#cartPanel h3{ margin:0; color:var(--accent); font-size:18px; }
#cartPanel .close-btn{ background:none;border:none;font-size:20px;cursor:pointer;color:#333; }

#cartPanelItems{ display:flex; flex-direction:column; gap:10px; overflow:auto; padding-right:6px; flex:1; }
.cart-panel-item{
  display:flex; gap:10px; align-items:center; background:#fbfbfb; padding:8px; border-radius:10px;
}
.cart-panel-item img{ width:60px; height:60px; object-fit:cover; border-radius:8px; }
.cart-panel-item .meta{ flex:1; }
.cart-panel-item .meta .name{ font-weight:700; color:var(--accent); margin-bottom:6px; }
.cart-panel-item .meta .qty{ color:var(--muted); font-size:13px; }
.cart-panel-item .meta .price{ font-weight:800; color:var(--accent); margin-top:6px; }

.cart-panel-controls{ display:flex; align-items:center; gap:8px; margin-top:6px; justify-content:flex-end; }

#cartPanelFooter{ border-top:1px solid #eee; padding-top:12px; display:flex; flex-direction:column; gap:8px; }
#cartPanelFooter .total-row{ display:flex; justify-content:space-between; align-items:center; font-weight:900; font-size:18px; color:var(--accent); }
#cartPanelFooter .btn-checkout{ width:100%; padding:10px 12px; border-radius:10px; border:none; cursor:pointer; font-weight:800; }

/* make panel responsive */
@media(max-width:520px){
  #cartPanel{ width:100%; right:-100%; }
  #cartPanel.active{ right:0; }
}

/* Modal / sheet (старый стиль оставлен для совместимости, но мы его не используем) */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,.45);z-index:80;padding:16px}
.modal.open{display:flex}
.sheet{width:min(980px,100%);max-height:92vh;overflow:auto;background:#fff;border-radius:14px;padding:12px;box-shadow:0 30px 60px rgba(2,6,23,.3);position:relative}
.close-x{position:absolute;right:12px;top:10px;cursor:pointer;font-size:20px}
.sheet-grid{display:grid;grid-template-columns:1fr 340px;gap:12px}
@media(max-width:900px){.sheet-grid{grid-template-columns:1fr}}
.cart-list{display:flex;flex-direction:column;gap:10px;padding:6px}

/* Cart text classes */
.cart-name{font-weight:700;color:var(--accent)}
.cart-qty{color:var(--muted)}
.cart-total{font-weight:700;color:var(--accent)}

.qty{display:flex;align-items:center;gap:6px}
.icon-btn{padding:6px;border-radius:8px;border:none;background:#f0f0f0;cursor:pointer}
.summary{background:#fafafa;border-radius:10px;padding:12px;display:flex;flex-direction:column;gap:10px}
.input{width:100%;padding:10px;border-radius:8px;border:1px solid #e7e7e7}

/* Cart text override for modal */
.sheet h3 { color: #000 !important; }
.sheet label { color: #000 !important; font-weight:600; }
#orderResult { color:#000 !important; font-weight:700; }
.sheet .total, .sheet .total span, #cartTotal { color:#000 !important; font-weight:800; }
#cartList .cart-name, #cartList .cart-qty, #cartList .cart-total, .cart-total, .cart-name { color:#000 !important; }

/* Visual upgrade: cards, slider, etc (kept) */
.tab { font-size: 14px; transition: transform .18s, box-shadow .18s; }
.tab:hover { transform: translateY(-2px); box-shadow:0 6px 18px rgba(0,0,0,.12); }
.card { transition: transform .25s ease, box-shadow .25s ease; }
.card:hover { transform: translateY(-8px) scale(1.02); box-shadow:0 20px 40px rgba(0,0,0,.12); }
.card-title { font-size: 16px; line-height:1.3; }
.card-desc { font-size:13px; line-height:1.4; }
.add-btn { font-size:13px; padding:6px 10px; }
.slider-container {  width: 100%; max-width: 1000px; margin: 0 auto; border-radius:18px; overflow:hidden; box-shadow:0 20px 60px rgba(0,0,0,.15); }
.slide img { transition: transform .35s ease; }
.slide.active img { transform: scale(1.02); }
#thumbs img { border:2px solid transparent; }
#thumbs img.active { border-color: var(--accent); transform: translateY(-4px); }

/* Skeleton / fly-to-cart (kept) */
.card.skeleton { background:#eee; color:transparent; pointer-events:none; min-height:220px; }
.card.skeleton .card-img { background:#ddd; height:160px; }
.fly-to-cart { position:fixed; z-index:9999; transition: transform 0.6s cubic-bezier(0.5,-0.5,0.5,1.5), opacity .4s; pointer-events:none; border-radius:12px; width:80px; height:80px; object-fit:cover; }

/* ----------------------------
  CATEGORY SLIDER (inside menu) — STICKY behavior
-----------------------------*/

/* tabs-slider: STICKY — when it reaches top it stays visible at top;
   when you scroll back up above its original spot it returns to place */
.tabs-slider{
  position: sticky;
  top: -10; /* прилипает к самому верху окна */
  z-index: 999; /* чтобы точно поверх контента */
  display:flex;
  align-items:center;
  gap:8px;
  margin: 0;
  padding: 8px 6px;
  background: transparent;
  border-radius: var(--radius);
}

/* track */
.tabs-track{
  display:flex;
  gap:10px;
  overflow-x:auto;
  scroll-behavior:smooth;
  -ms-overflow-style:none;
  scrollbar-width:none;
  flex:1 1 auto;
  padding:2px 8px;
}
.tabs-track::-webkit-scrollbar{ display:none; }

/* arrows */
.tabs-arrow{ background:#fff; border:none; border-radius:999px; width:36px; height:36px; display:grid; place-items:center; cursor:pointer; box-shadow:0 6px 18px rgba(0,0,0,.08); font-size:18px; }
.tabs-arrow:active{ transform:scale(.98); }

/* inside menu view we give the track a bg to match page bg and rounded pill */
#menuView .tabs-track{
  background: var(--bg);
  border-radius: 12px;
  padding: 8px;
}

/* make tabs not wrap inside track */
.tabs-track .tab{ white-space:nowrap; flex:0 0 auto; }

/* ================== КОНТАКТИ (НОВЫЙ СТИЛЬ) ================== */
.contacts {
  border-radius:18px;
  padding:24px;
  gap:24px;
  box-shadow:0 20px 40px rgba(0,0,0,.15);
  display:flex;
  align-items:flex-start;
  flex-wrap:wrap;
  color:var(--accent);
  font-size:15px;
  line-height:1.5;
}

/* left column: infos + form */
.contact-left{
  flex:1;
  min-width:300px;
  display:flex;
  flex-direction:column;
  gap:20px;
}

.contact-info h3{
  font-size:18px;
  margin:0 0 8px 0;
  color:var(--accent);
}

.contact-row{
  color:var(--accent);
  font-weight:600;
}

.contact-row a{
  color:var(--accent);
  text-decoration:none;
}

.contact-row a:hover{
  text-decoration:underline;
}

/* ================== ФОРМА ЗВОРОТНОГО ЗВ'ЯЗКУ ================== */
.contact-form{
  background:#2a2a2a;
  padding:16px;
  border-radius:18px;
  display:flex;
  flex-direction:column;
  gap:12px;
  box-shadow:0 12px 30px rgba(2,6,23,.3);
}

.contact-form h4{
  margin:0 0 6px 0;
  font-size:16px;
  color:var(--accent);
  font-weight:700;
}

.contact-form .input{
  background:#fff;
  color:#111;
  border-radius:12px;
  padding:10px 12px;
  border:none;
  font-size:14px;
  width:100%;
  box-shadow:0 6px 18px rgba(0,0,0,.08);
  transition:all .18s;
}

.contact-form .input:focus{
  outline:none;
  box-shadow:0 6px 18px rgba(255,153,0,.45);
  transform:translateY(-2px);
}

.contact-form button{
  background:linear-gradient(120deg,var(--accent),#ffb347);
  color:#fff;
  font-weight:700;
  font-size:14px;
  border:none;
  border-radius:12px;
  padding:10px 0;
  cursor:pointer;
  transition:all .18s;
}

.contact-form button:hover{
  box-shadow:0 12px 30px rgba(255,153,0,.45);
  transform:translateY(-2px);
}

#feedbackResult{
  color:var(--accent);
  font-weight:700;
  font-size:14px;
  margin-top:6px;
}

/* Responsive: map below text on small screens */
@media(max-width:900px){
  .contacts { flex-direction:column; }
  .map { order:2; width:100%; min-height:200px; }
  .contact-left { order:1; width:100%; }
}

/* ================== RANDOM VIEW ADJUSTMENTS ================== */
/* Центрируем всю секцию рандома и делаем карточку шире, картинка НЕ обрезается сильно */
#randomView { display:flex; align-items:center; justify-content:center; padding:28px; min-height:60vh; }
#randomView .random-inner { width:100%; max-width:900px; display:flex; flex-direction:column; align-items:center; gap:18px; }
#randomView .random-controls { display:flex; gap:12px; align-items:center; flex-wrap:wrap; justify-content:center; }
#randomView .random-note { color:var(--muted); font-size:14px; }
#randomContainer { width:100%; display:flex; align-items:center; justify-content:center; margin-top:6px; }

/* карточка рандомного блюда — шире и с более высоким изображением */
#randomContainer .card { max-width:620px; width:100%; margin:0; }
#randomContainer .card-img { height:320px; object-fit:contain; background:#fafafa; display:block; }

/* при мобильном — чуть уменьшать высоту картинки */
@media(max-width:720px){
  #randomContainer .card-img { height:220px; }
  #randomView { min-height:50vh; padding:16px; }
  #randomContainer .card { padding:0; }
}
/* Search input minor styling */
#menuSearch {
  width:100%;
  padding:10px 12px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,0.08);
  background:rgba(255,255,255,0.06);
  color:var(--muted);
  font-size:15px;
  margin:16px 0;
}
#menuSearch::placeholder { color: rgba(230,238,246,0.5); }

/* ================== PRODUCT DETAIL MODAL ================== */
/* minimal styles for modal with product details + similar items */
#productModal{ display:none; position:fixed; inset:0; background:rgba(2,6,23,.6); z-index:1200; align-items:center; justify-content:center; padding:20px; }
#productModal.open{ display:flex; }
#productModal .modal-card{ background:#fff; color:#0b1220; border-radius:12px; max-width:980px; width:100%; display:grid; grid-template-columns:1fr 340px; gap:16px; padding:16px; box-shadow:0 30px 60px rgba(2,6,23,.3); position:relative; }
@media(max-width:900px){ #productModal .modal-card{ grid-template-columns:1fr; } }
#productModal .pm-left img{ width:100%; height:360px; object-fit:cover; border-radius:10px; display:block; }
#productModal .pm-right{ display:flex; flex-direction:column; gap:10px; }
#productModal .pm-name{ font-size:20px; font-weight:800; color:var(--accent); margin:0; }
#productModal .pm-desc{ color:#333; font-size:14px; line-height:1.4; }
#productModal .pm-price{ font-weight:900; font-size:18px; color:var(--accent); margin-top:6px; }
#productModal .close-btn-modal{ position:absolute; top:10px; right:12px; background:none; border:none; font-size:22px; cursor:pointer; color:#333; z-index:1300; }
#productModal .similar-list{ display:flex; flex-direction:column; gap:8px; margin-top:8px; max-height:320px; overflow:auto; padding-right:6px; }
.similar-item{ display:flex; gap:8px; align-items:center; padding:8px; border-radius:8px; background:#fafafa; cursor:pointer; }
.similar-item img{ width:64px; height:64px; object-fit:cover; border-radius:8px; }
.similar-item .sim-meta{ font-size:13px; color:#0b1220; }

/* small adjustments for buttons inside modal */
#productModal .btn { margin-top:8px; width:100%; }
#productModal .pm-right .btn-inline { width:auto; display:inline-block; }

/* ================== MOBILE ADAPTATION ================== */
@media(max-width:600px){
  #productModal{ padding:10px; }
  #productModal .modal-card{ 
    padding:12px; 
    gap:12px; 
    max-height:95vh; 
    overflow-y:auto; 
  }
  #productModal .pm-left img{ 
    height:220px; 
    border-radius:8px; 
  }
  #productModal .pm-name{ font-size:18px; }
  #productModal .pm-price{ font-size:16px; }
  #productModal .pm-desc{ font-size:13px; }
  #productModal .similar-list{ max-height:200px; }
  .similar-item img{ width:48px; height:48px; }
  .similar-item .sim-meta{ font-size:12px; }
  
  /* увеличенная и всегда доступная кнопка закрытия */
  #productModal .close-btn-modal{ 
    font-size:28px; 
    top:12px; 
    right:16px; 
    padding:6px 10px;
    background:rgba(255,255,255,0.85);
    border-radius:50%;
    line-height:1;
  }
}
</style>

</head>
<body>
<div class="container">
  <div class="header">
    <div style="display:flex;align-items:center;gap:12px">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>Sushi Fox</h1>
        <div class="subtitle">Доставка: суші, напої, бургери, салати</div>
      </div>
    </div>
  </div>

  <!-- NAVBAR SPA -->
  <div class="tabs" id="mainTabs" aria-label="Навігація">
    <div class="tab active" data-view="home">Головна</div>
    <div class="tab" data-view="menu">Меню</div>
    <div class="tab" data-view="random">🎲 Рандомне блюдо</div>
    <div class="tab" data-view="contacts">Контакти</div>
  </div>

  <!-- SPA CONTENT -->
  <div id="spaContent">
    <div id="homeView" class="spa-view" style="display:block;padding:20px;text-align:center;">
      <h2>Ласкаво просимо до Sushi Fox!</h2>
      <p>Доставка суші, напоїв, бургерів та салатів прямо до вашого дому.</p>
      <img src="images/15.gif" alt="Sushi Fox" style="max-width:100%;border-radius:18px;box-shadow:var(--shadow);margin-top:12px">
    </div>

    <div id="menuView" class="spa-view" style="display:none;">
      <!-- CATEGORY SLIDER (inside menu view) -->
      <div class="tabs-slider" aria-hidden="false">
        <button class="tabs-arrow left" id="catPrev" aria-label="Назад">❮</button>
        <div id="tabs" class="tabs-track" aria-label="Категорії" role="tablist"></div>
        <button class="tabs-arrow right" id="catNext" aria-label="Вперед">❯</button>
      </div>

      <div class="section">
        <div class="slider-container" id="sliderBlock">
          <img id="mainSlide" src="images/slide1.jpg" alt="Slide" />
          <div class="thumbs-row">
            <div id="thumbs" aria-hidden="true"></div>
          </div>
        </div>
      </div>

      <div class="section">
        <input id="menuSearch" placeholder="Пошук по меню (назва, опис, ID)..." aria-label="Пошук по меню" />
      </div>

      <div class="section">
        <div id="products" class="products" aria-live="polite"></div>
      </div>
    </div>

    <div id="randomView" class="spa-view" style="display:none;">
      <div class="random-inner">
        <h2>🎲 Рандомне блюдо</h2>
        <div class="random-controls" role="region" aria-label="Random controls">
          <button id="randomBtn" class="btn">Згенерувати рандомне блюдо</button>
          <div id="randomNote" class="random-note">Бере випадковий товар із усього меню Poster</div>
        </div>
        <div id="randomContainer"></div>
      </div>
    </div>

    <div id="contactsView" class="spa-view" style="display:none;">
      <!-- Контакты -->
      <div class="contacts">
        <div class="contact-left">
          <div class="contact-info">
            <h3 style="margin-top:0">Контакти</h3>
            <div class="contact-row">📞 Телефон: <a class="link" href="tel:+380662714304">+38 (066) 271-43-04</a></div>
            <div class="contact-row">🕘 Час роботи: 10:00 — 22:00</div>
            <div class="contact-row">📍 Адреса: Вольногорськ, бульвар Миру 15</div>
            <div class="contact-row">📸 Instagram: <a class="link" href="https://www.instagram.com/sushi_fox_volnohorsk/" target="_blank">@sushi_fox_volnohorsk</a></div>
            <div class="contact-row">✈️ Telegram: <a class="link" href="https://t.me/SanyaSushist" target="_blank">SanyaSushist</a></div>
            <div class="contact-row">✉️ Email: <a class="link" href="mailto:contact@sushi-fox.ua">contact@sushi-fox.ua</a></div>
          </div>

          <!-- Netlify form: заменил старую локальную форму на эту -->
          <form id="feedbackForm" class="contact-form" name="feedback" method="POST" data-netlify="true" netlify-honeypot="bot-field" aria-label="Форма зворотного зв'язку">
            <!-- скрытое поле для Netlify -->
            <input type="hidden" name="form-name" value="feedback" />
            <p style="display:none">
              <label>Don’t fill this out: <input name="bot-field" /></label>
            </p>

            <h4>Зворотній зв'язок</h4>
            <input id="fbName" name="name" class="input" placeholder="Ваше ім'я" required />
            <input id="fbPhone" name="phone" class="input" placeholder="Номер телефону" type="tel" required />
            <textarea id="fbMessage" name="message" class="input" placeholder="Повідомлення" rows="4" required></textarea>
            <button type="submit">Надіслати</button>
            <div id="feedbackResult" role="status" aria-live="polite"></div>
          </form>

        </div>

        <div class="map">
          <iframe id="contactMap" src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d2604.4893619324837!2d34.0087415!3d48.4757868!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x40da4a14a7640001%3A0xf601f29d7836a3b!2z0JvQu9C40L7Qu9C10L3QuNC90LjRgtC10YDQtdC70Yw!5e0!3m2!1suk!2sua!4v1695037185269!5m2!1suk!2sua" width="100%" height="100%" style="border:0;" allowfullscreen="" loading="lazy"></iframe>
          <div style="position:relative;margin-top:10px;text-align:center">
            <a href="https://www.google.com/maps/search/?api=1&query=%D0%92%D0%BE%D0%BB%D1%8C%D0%BD%D0%BE%D0%B3%D0%BE%D1%80%D1%81%D1%8C%D0%BA+%D0%B1%D1%83%D0%BB%D1%8C%D0%B2%D0%B0%D1%80+%D0%9C%D0%B8%D1%80%D1%83+15" target="_blank" rel="noopener" class="btn" style="display:inline-block;margin-top:8px;padding:8px 12px">Відкрити в Google Maps</a>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<div class="cart-fab" id="openCart" title="Кошик">🛒<div class="cart-count" id="cartCount">0</div></div>

<div id="cartOverlay" aria-hidden="true"></div>

<aside id="cartPanel" aria-hidden="true" role="dialog" aria-label="Кошик">
  <div class="panel-header">
    <h3>Ваше замовлення</h3>
    <button class="close-btn" id="cartPanelClose" title="Закрити">✕</button>
  </div>

  <div id="cartPanelItems" aria-live="polite">
  </div>

  <div id="cartPanelFooter">
    <div style="display:flex;gap:8px;flex-direction:column">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <span style="color:#666">Разом</span>
        <span id="cartPanelTotal" style="font-weight:900;color:var(--accent)">0₴</span>
      </div>

      <div style="display:flex;flex-direction:column;gap:8px;margin-top:6px">
        <input id="custName" class="input" placeholder="Ім'я *" />
        <input id="custPhone" class="input" placeholder="Телефон *" />
        <input id="custAddr" class="input" placeholder="Адреса (вулиця, буд., під'їзд)" />
        <textarea id="custNote" class="input" placeholder="Коментар до замовлення" rows="3"></textarea>
      </div>

      <button id="checkoutOrder" class="btn btn-checkout" style="background:linear-gradient(120deg,var(--accent),#ffb347);color:#fff">Оформити замовлення</button>
      <div id="orderResult" style="font-weight:700;margin-top:8px;color:#333"></div>
    </div>
  </div>
</aside>

<!-- === PRODUCT DETAIL MODAL (inserted) === -->
<div id="productModal" role="dialog" aria-hidden="true" aria-label="Деталі товару">
  <div class="modal-card" role="document">
    <button class="close-btn-modal" id="pmClose" aria-label="Закрити">✕</button>

    <div class="pm-left">
      <img id="pmImg" src="" alt="Зображення товару" />
    </div>

    <div class="pm-right">
      <h3 class="pm-name" id="pmName"></h3>
      <div class="pm-desc" id="pmDesc"></div>
      <div class="pm-price" id="pmPrice"></div>

      <div>
        <button id="pmAdd" class="btn btn-inline">Додати в кошик</button>
      </div>

      <h4 style="margin-top:12px">Похожі товари</h4>
      <div id="pmSimilar" class="similar-list" aria-live="polite"></div>
    </div>
  </div>
</div>
<!-- === END PRODUCT DETAIL MODAL === -->

<script>
(function initSPA(){
  const mainTabs = document.querySelectorAll('#mainTabs .tab');
  const views = {
    home: document.getElementById('homeView'),
    menu: document.getElementById('menuView'),
    random: document.getElementById('randomView'),
    contacts: document.getElementById('contactsView')
  };
  mainTabs.forEach(tab => {
    tab.addEventListener('click', ()=>{
      mainTabs.forEach(t=>t.classList.remove('active'));
      tab.classList.add('active');
      const view = tab.getAttribute('data-view');
      Object.keys(views).forEach(v => { views[v].style.display = (v===view ? 'block' : 'none'); });
      if(view === 'menu') {
        try { if(typeof renderSlider === 'function') renderSlider(window.lastRenderedProducts); } catch(e){ /* пусто */ }
        setTimeout(updateCategoryArrows, 120);
      }
    });
  });
})();

const MENU_API = '/.netlify/functions/menu';
const ORDER_API = '/.netlify/functions/order';
const LIQPAY_API = '/.netlify/functions/liqpay';
const IMG_FALLBACK = '/images/noimage.png';

const slidesImages = [
  "images/slide1.png",
  "images/slide2.png",
  "images/slide3.png",
  "images/slide4.png",
  "images/slide5.png"
];

let sliderInterval = null;
let sliderIndex = 0;

function renderSlider(/* products ignored — global slider */){
  const main = document.getElementById('mainSlide');
  const thumbsContainer = document.getElementById('thumbs');
  if(!main || !thumbsContainer) return;

  const slides = Array.isArray(slidesImages) && slidesImages.length ? slidesImages : ["images/placeholder1.jpg"];

  if(sliderIndex >= slides.length) sliderIndex = 0;
  if(sliderIndex < 0) sliderIndex = 0;

  main.src = slides[sliderIndex];

  thumbsContainer.innerHTML = '';
  slides.forEach((src, i) => {
    const img = document.createElement('img');
    img.src = src;
    img.alt = 'thumb-' + i;
    if(i === sliderIndex) img.classList.add('active');
    img.addEventListener('click', (e)=> {
      sliderIndex = i;
      updateMainSlide();
      resetSliderInterval();
    });
    thumbsContainer.appendChild(img);
  });

  initSliderLightbox();

  resetSliderInterval();
}

function updateMainSlide(){
  const main = document.getElementById('mainSlide');
  const thumbs = document.querySelectorAll('#thumbs img');
  const slides = Array.isArray(slidesImages) && slidesImages.length ? slidesImages : ["images/placeholder1.jpg"];
  if(!main) return;
  sliderIndex = ((sliderIndex % slides.length) + slides.length) % slides.length;
  main.src = slides[sliderIndex];
  thumbs.forEach((t,i)=> t.classList.toggle('active', i === sliderIndex));
}

function resetSliderInterval(){
  if(sliderInterval) clearInterval(sliderInterval);
  sliderInterval = setInterval(()=>{
    const slides = Array.isArray(slidesImages) && slidesImages.length ? slidesImages : ["images/placeholder1.jpg"];
    sliderIndex = (sliderIndex + 1) % slides.length;
    updateMainSlide();
  }, 10000); // 10 000 ms = 10 s
}

function initSliderLightbox(){
  const main = document.getElementById('mainSlide');
  if(main){
    main.onclick = ()=> openLightbox(main);
  }
  document.querySelectorAll('#thumbs img').forEach(img=>{
    img.onclick = ()=> openLightbox(img);
  });
}
// ======= свайп на телефоне =======
function initSwipe(){
  const slider = document.querySelector('.slider-container');
  if(!slider) return;

  let startX = 0;
  slider.addEventListener('touchstart', e => startX = e.touches[0].clientX);
  slider.addEventListener('touchend', e => {
    let endX = e.changedTouches[0].clientX;
    if(Math.abs(endX - startX) > 30){ // минимальный порог
      if(endX < startX){
        sliderIndex = (sliderIndex + 1) % slidesImages.length; // свайп влево → следующий
      } else {
        sliderIndex = (sliderIndex - 1 + slidesImages.length) % slidesImages.length; // свайп вправо → предыдущий
      }
      updateMainSlide();
      resetSliderInterval();
    }
  });
}

function initWheel(){
  const slider = document.querySelector('.slider-container');
  if(!slider) return;

  slider.addEventListener('wheel', e => {
    e.preventDefault();
    if(e.deltaY < 0){
      sliderIndex = (sliderIndex - 1 + slidesImages.length) % slidesImages.length;
    } else {
      sliderIndex = (sliderIndex + 1) % slidesImages.length;
    }
    updateMainSlide();
    resetSliderInterval();
  });
}

// ======= инициализация =======
document.addEventListener('DOMContentLoaded', () => {
  updateMainSlide();
  resetSliderInterval();
  initSliderLightbox();
  initSwipe();
  initWheel();
});

const popularIds = ['87','88']; // популярные товары
const newIds = ['86','88','85','87'];     // новинки

let allProducts = [];
let categories = [];
let currentCategory = null;
let cart = JSON.parse(localStorage.getItem('sushi_cart') || '[]');

function formatUAH(n){ return Math.round(n) + '₴'; }
function safeImg(url){ return url ? url : IMG_FALLBACK; }
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, (m)=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

function getProductId(p){
  return String(p.id || p.product_id || p.name || '');
}

function getBadgesHtml(p){
  try {
    const id = getProductId(p);
    const badges = [];
    const popularNormalized = popularIds.map(String);
    const newNormalized = newIds.map(String);
    if(popularNormalized.includes(id)) badges.push('<span class="badge badge-popular" aria-hidden="true">🔥 Популярне</span>');
    if(newNormalized.includes(id)) badges.push('<span class="badge badge-new" aria-hidden="true">⭐ Новинка</span>');
    return badges.join(' ');
  } catch(e){
    return '';
  }
}

async function loadMenu(){
  try{
    const res = await fetch(MENU_API);
    if(!res.ok) throw new Error('Не вдалося завантажити меню з сервера');
    const data = await res.json();

    if (data?.products && Array.isArray(data.products)) {
      allProducts = data.products;

      const rawCategories = Array.isArray(data.categories) && data.categories.length
        ? data.categories
        : Array.from(new Set(allProducts.map(p=>p.category || 'Інше')));

      // ФИЛЬТР: убираем категории без товаров с ценой > 0, но оставляем "Комплектація"
      categories = rawCategories.filter(cat=>{
        try {
          const norm = String(cat).trim().toLowerCase();
          if(norm === 'комплектація') return true;
          return allProducts.some(p => {
            const pCat = (p.category || 'Інше');
            return String(pCat) === String(cat) && Number(p.price) > 0;
          });
        } catch(e) { return false; }
      });

      if(!categories.length){
        const nonZeroCats = Array.from(new Set(allProducts.filter(p=>Number(p.price)>0).map(p=>p.category || 'Інше')));
        categories = nonZeroCats.length ? nonZeroCats : Array.from(new Set(allProducts.map(p=>p.category || 'Інше')));
      }

    } else {
      allProducts = [];
      categories = [];
      console.warn('menu: отримано порожнi дані');
    }
    renderCategories();

    if(categories.length){
      if(!currentCategory || !categories.includes(currentCategory)){
        showCategory(categories[0]);
      } else {
        showCategory(currentCategory);
      }
    } else {
      document.getElementById('products').innerHTML = '<div style="padding:20px;color:var(--muted)">Меню порожнє</div>';
    }

    setTimeout(updateCategoryArrows, 120);
  } catch(err){
    console.error('loadMenu error', err);
    document.getElementById('products').innerHTML = `<div style="padding:20px;color:var(--muted)">Помилка при завантаженні меню</div>`;
  }
}

const categoryOrder = {
  "Сети": ["98","110","113","119","122","124","129","132","137","140","141","146","151","152","158","159","160","161"],
  "Фірмові Дракони": ["85","86","87","88"],
  "Класичні роли": ["9","46","50","54","55","59","60","65","66","69","70","71","72","73","74","75","76","80"],
  "Макі роли": ["13","14","15","16","17","18","19","20","21","23","28","29","30","31","32"],
  "Футомакі": ["33","34","35","36"],
  "Fox роли (фірмові)": ["53","56","57","58","61","62","63","64","67","68","77","78","79","81","82","83","84"],
  "Теплі роли": ["12","91","92","93","94","95","96","97"],
  "Сезам роли": ["43","44","45"],
  "Суші": ["37","38","39","40","41","42"]
};

function applyCategoryOrder(products, categoryName){
  try {
    const orderArr = Array.isArray(categoryOrder[categoryName]) ? categoryOrder[categoryName].map(String) : null;
    if(!orderArr || !orderArr.length) return products; 

    const remaining = products.slice(); 
    const ordered = [];

    orderArr.forEach(id => {
      for(let i = 0; i < remaining.length; i++){
        if(getProductId(remaining[i]) === String(id)){
          ordered.push(remaining[i]);
          remaining.splice(i,1);
          i--; 
        }
      }
    });

    return ordered.concat(remaining);
  } catch(e){
    console.warn('applyCategoryOrder error', e);
    return products;
  }
}

function renderCategories(){
  const tabs = document.getElementById('tabs'); 
  if(!tabs) return; 
  tabs.innerHTML='';

  categories
    .filter(cat => cat !== "Що треба рекомендувати та знижки!") 
    .forEach(cat=>{
      const el = document.createElement('div'); 
      el.className='tab'; 
      el.textContent = cat;
      el.onclick = ()=> showCategory(cat);
      tabs.appendChild(el);
    });

  updateCategoryArrows();
}

function showCategory(cat){
  currentCategory = cat;
  document.querySelectorAll('#tabs .tab').forEach(t=> 
    t.classList.toggle('active', t.textContent===cat)
  );

  let prods = allProducts.filter(p => (p.category || 'Інше') === cat);

  prods = applyCategoryOrder(prods, cat);

  renderProducts(prods);
  renderSlider && renderSlider(prods);
  window.lastRenderedProducts = prods;

  applySearchFilter();
}

function renderProducts(products){
  const wrap = document.getElementById('products'); if(!wrap) return; wrap.innerHTML = '';
  if(!products.length){ wrap.innerHTML = '<div style="padding:18px;color:var(--muted)">Немає товарів у цій категорії</div>'; return; }
  products.forEach(p=>{
    const card = document.createElement('div'); 
    card.className = 'card product-item';
    card.setAttribute('data-name', (p.name||'').toLowerCase());
    card.setAttribute('data-desc', (p.desc||'').toLowerCase());
    card.setAttribute('data-id', String(getProductId(p)));

    const badgesHtml = getBadgesHtml(p);
    card.innerHTML = `
      <img loading="lazy" src="${safeImg(p.img)}" alt="${escapeHtml(p.name)}" class="card-img product-img" />
      <div class="card-body">
        <div class="card-title">
          <span style="flex:1">${escapeHtml(p.name)}</span>
          <span aria-hidden="true">${badgesHtml}</span>
        </div>
        <div class="card-desc">${escapeHtml(p.desc || '')}</div>
        <div class="card-row">
          <div class="price">${formatUAH(p.price)}</div>
          <button class="btn add-btn">В кошик</button>
        </div>
      </div>`;
    card.querySelector('.add-btn').addEventListener('click', ()=> addToCartFromProduct(p));
    wrap.appendChild(card);
  });
  initProductLightbox();

  applySearchFilter();
}

function applySearchFilter(){
  const input = document.getElementById('menuSearch');
  if(!input) return;
  const q = (input.value || '').trim().toLowerCase();
  const items = document.querySelectorAll('.product-item');
  if(!q){
    items.forEach(it => { it.style.display = ''; });
    return;
  }
  let anyVisible = false;
  items.forEach(it => {
    const name = it.getAttribute('data-name') || '';
    const desc = it.getAttribute('data-desc') || '';
    const id = it.getAttribute('data-id') || '';
    const match = name.includes(q) || desc.includes(q) || id.includes(q);
    it.style.display = match ? '' : 'none';
    if(match) anyVisible = true;
  });

  const wrap = document.getElementById('products');
  if(wrap){
    let noneEl = document.getElementById('noSearchResults');
    if(!anyVisible){
      if(!noneEl){
        noneEl = document.createElement('div');
        noneEl.id = 'noSearchResults';
        noneEl.style.padding = '18px';
        noneEl.style.color = 'var(--muted)';
        noneEl.textContent = 'Нічого не знайдено';
        wrap.appendChild(noneEl);
      }
    } else {
      if(noneEl) noneEl.remove();
    }
  }
}

document.getElementById('menuSearch')?.addEventListener('input', applySearchFilter);

/* ================== PRODUCT DETAIL MODAL JS ================== */
/* Event delegation: open modal when clicking on card (.product-item) */
(function initProductModalHandlers(){
  const productsWrap = document.getElementById('products');
  const modal = document.getElementById('productModal');
  const pmClose = document.getElementById('pmClose');
  const pmImg = document.getElementById('pmImg');
  const pmName = document.getElementById('pmName');
  const pmDesc = document.getElementById('pmDesc');
  const pmPrice = document.getElementById('pmPrice');
  const pmSimilar = document.getElementById('pmSimilar');
  const pmAdd = document.getElementById('pmAdd');

  function closeModal(){
    modal.classList.remove('open');
    modal.setAttribute('aria-hidden','true');
    document.body.style.overflow = '';
    document.removeEventListener('keydown', escHandler);
  }
  function openModal(){
    modal.classList.add('open');
    modal.setAttribute('aria-hidden','false');
    document.body.style.overflow = 'hidden';
    document.addEventListener('keydown', escHandler);
  }
  function escHandler(e){ if(e.key === 'Escape') closeModal(); }

  pmClose.addEventListener('click', closeModal);
  modal.addEventListener('click', (e)=>{
    if(e.target === modal) closeModal();
  });

  // click on product card (event delegation)
  productsWrap?.addEventListener('click', (e)=>{
    const card = e.target.closest && e.target.closest('.product-item');
    if(!card) return;
    const id = String(card.getAttribute('data-id') || '');
    if(!id) return;
    const product = allProducts.find(p => getProductId(p) === id);
    if(!product) return;
    showProductDetails(product);
  });

  // Show modal with product object from allProducts
  function showProductDetails(product){
    if(!product) return;
    pmImg.src = safeImg(product.img);
    pmImg.alt = product.name || 'Товар';
    pmName.textContent = product.name || '';
    pmDesc.textContent = product.desc || product.ingredients || '';
    pmPrice.textContent = (typeof product.price !== 'undefined') ? formatUAH(product.price) : '';

    // attach add to cart
    pmAdd.onclick = (ev) => {
      try{
        addToCartFromProduct(product);
        // небольшая подсказка перед закрытием
        pmAdd.textContent = 'Додано ✅';
        setTimeout(()=> { pmAdd.textContent = 'Додати в кошик'; }, 900);
      }catch(err){ console.error('pmAdd error', err); }
    };

    // build similar products: prefer same category, exclude current
    pmSimilar.innerHTML = '';
    let pool = allProducts.filter(p => getProductId(p) !== getProductId(product));
    const sameCat = pool.filter(p => (p.category || '') === (product.category || ''));
    if(sameCat.length >= 3) pool = sameCat;
    // shuffle and take up to 3
    for(let i = pool.length - 1; i > 0; i--){
      const j = Math.floor(Math.random() * (i + 1));
      [pool[i], pool[j]] = [pool[j], pool[i]];
    }
    const chosen = pool.slice(0,3);
    if(chosen.length === 0){
      const noEl = document.createElement('div');
      noEl.style.color = 'var(--muted)';
      noEl.textContent = 'Немає схожих товарів';
      pmSimilar.appendChild(noEl);
    } else {
      chosen.forEach(sp=>{
        const div = document.createElement('div');
        div.className = 'similar-item';
        div.setAttribute('data-id', getProductId(sp));
        div.innerHTML = `<img src="${safeImg(sp.img)}" alt="${escapeHtml(sp.name)}"><div class="sim-meta"><div>${escapeHtml(sp.name)}</div><div style="color:var(--muted);font-weight:700">${formatUAH(sp.price)}</div></div>`;
        div.addEventListener('click', ()=> {
          showProductDetails(sp); // recurse to show selected similar product
          // scroll modal to top for better UX on mobile
          const modalCard = modal.querySelector('.modal-card');
          modalCard && modalCard.scrollIntoView({behavior:'smooth', block:'center'});
        });
        pmSimilar.appendChild(div);
      });
    }

    openModal();
  }

  // expose function for other parts if needed
  window.showProductDetails = function(productIdOrObj){
    if(!productIdOrObj) return;
    if(typeof productIdOrObj === 'object') return showProductDetails(productIdOrObj);
    const id = String(productIdOrObj);
    const product = allProducts.find(p => getProductId(p) === id);
    if(product) showProductDetails(product);
  };
})();
/* ================== END PRODUCT DETAIL MODAL JS ================== */

function addToCartFromProduct(p){
  const id = p.id || p.product_id || p.name;
  const existing = cart.find(c=>c.id === id);
  if(existing) existing.qty++;
  else cart.push({ id, name: p.name, price: Number(p.price)||0, qty:1, img: p.img || IMG_FALLBACK });
  saveCart(); updateCartUI();
}
function saveCart(){ localStorage.setItem('sushi_cart', JSON.stringify(cart)); }

function updateCartUI(){
  // обновляем счётчик на FAB
  if(document.getElementById('cartCount')) document.getElementById('cartCount').textContent = cart.reduce((a,c)=>a+c.qty,0);

  const listEl = document.getElementById('cartList'); if(listEl) listEl.innerHTML = '';
  cart.forEach((c,i)=>{
    if(listEl){
      const div = document.createElement('div'); div.className = 'cart-item';
      div.innerHTML = `<img src="${safeImg(c.img)}" alt="${escapeHtml(c.name)}"/>
        <div>
          <div class="cart-name">${escapeHtml(c.name)}</div>
          <div class="cart-qty">${formatUAH(c.price)} × ${c.qty}</div>
        </div>
        <div style="text-align:right">
          <div class="cart-total">${formatUAH(c.price * c.qty)}</div>
          <div style="margin-top:8px">
            <button class="icon-btn" data-idx="${i}" data-op="-1">−</button>
            <button class="icon-btn" data-idx="${i}" data-op="+1">+</button>
            <button class="icon-btn" data-idx="${i}" data-op="remove" style="margin-left:6px">✕</button>
          </div>
        </div>`;
      listEl.appendChild(div);
    }
  });

  const panelItems = document.getElementById('cartPanelItems');
  if(panelItems) panelItems.innerHTML = '';
  cart.forEach((c,i)=>{
    const item = document.createElement('div');
    item.className = 'cart-panel-item';
    item.innerHTML = `
      <img src="${safeImg(c.img)}" alt="${escapeHtml(c.name)}" />
      <div class="meta">
        <div class="name">${escapeHtml(c.name)}</div>
        <div class="qty">${formatUAH(c.price)} × ${c.qty}</div>
        <div class="cart-panel-controls">
          <button class="icon-btn" data-idx="${i}" data-op="-1">−</button>
          <button class="icon-btn" data-idx="${i}" data-op="+1">+</button>
          <button class="icon-btn" data-idx="${i}" data-op="remove" style="margin-left:6px">✕</button>
        </div>
      </div>
    `;
    panelItems.appendChild(item);
  });

  document.querySelectorAll('.icon-btn').forEach(btn=>{
    btn.onclick = ()=>{
      const idx = Number(btn.getAttribute('data-idx'));
      const op = btn.getAttribute('data-op');
      if(op === 'remove'){ cart.splice(idx,1); }
      else { cart[idx].qty += Number(op); if(cart[idx].qty < 1) cart.splice(idx,1); }
      saveCart(); updateCartUI();
    };
  });

  const total = cart.reduce((a,c)=>a + c.price*c.qty,0);
  if(document.getElementById('cartTotal')) document.getElementById('cartTotal').textContent = formatUAH(total);
  if(document.getElementById('cartPanelTotal')) document.getElementById('cartPanelTotal').textContent = formatUAH(total);
}

const cartOverlay = document.getElementById('cartOverlay');
const cartPanel = document.getElementById('cartPanel');
const openCartBtn = document.getElementById('openCart');
const cartPanelClose = document.getElementById('cartPanelClose');

function openCartPanel(){
  cartPanel.classList.add('active');
  cartOverlay.classList.add('active');
  cartPanel.setAttribute('aria-hidden','false');
  cartOverlay.setAttribute('aria-hidden','false');
  document.body.style.overflow = 'hidden';
  updateCartUI();
}
function closeCartPanel(){
  cartPanel.classList.remove('active');
  cartOverlay.classList.remove('active');
  cartPanel.setAttribute('aria-hidden','true');
  cartOverlay.setAttribute('aria-hidden','true');
  document.body.style.overflow = '';
}

openCartBtn?.addEventListener('click', openCartPanel);
cartPanelClose?.addEventListener('click', closeCartPanel);
cartOverlay?.addEventListener('click', closeCartPanel);
document.addEventListener('keydown', (e)=> { if(e.key === 'Escape') closeCartPanel(); });

(function makeFabDraggable(){
  const fab = document.getElementById('openCart');
  if(!fab) return;

  let dragging = false;
  let startX = 0, startY = 0;
  let origLeft = 0, origTop = 0;
  let moved = false;

  fab.addEventListener('pointerdown', function (e) {
    if (e.pointerType === 'mouse' && e.button !== 0) return;
    e.preventDefault();
    fab.setPointerCapture && fab.setPointerCapture(e.pointerId);
    dragging = true;
    moved = false;
    startX = e.clientX;
    startY = e.clientY;
    const rect = fab.getBoundingClientRect();
    origLeft = rect.left;
    origTop = rect.top;
    fab.style.transition = 'none';
    if (!fab.style.left) fab.style.left = rect.left + 'px';
    if (!fab.style.top) fab.style.top = rect.top + 'px';
    fab.style.right = 'auto';
    fab.style.bottom = 'auto';
  });

  document.addEventListener('pointermove', function (e) {
    if (!dragging) return;
    e.preventDefault();
    const dx = e.clientX - startX;
    const dy = e.clientY - startY;
    const vw = window.innerWidth;
    const vh = window.innerHeight;
    const w = fab.offsetWidth;
    const h = fab.offsetHeight;
    let left = origLeft + dx;
    let top = origTop + dy;
    left = Math.max(8, Math.min(left, vw - w - 8));
    top = Math.max(8, Math.min(top, vh - h - 8));
    fab.style.left = left + 'px';
    fab.style.top = top + 'px';
    moved = moved || (Math.hypot(dx, dy) > 3);
  });

  function endDrag(e) {
    if (!dragging) return;
    dragging = false;
    try { fab.releasePointerCapture && fab.releasePointerCapture(e && e.pointerId); } catch(err){}
    fab.style.transition = 'box-shadow .2s';
    if (moved) {
      const blocker = function (ev) { ev.stopImmediatePropagation(); ev.preventDefault(); };
      fab.addEventListener('click', blocker, true);
      setTimeout(()=> fab.removeEventListener('click', blocker, true), 300);
    }
  }
  document.addEventListener('pointerup', endDrag);
  document.addEventListener('pointercancel', endDrag);

  window.addEventListener('resize', function(){
    const vw = window.innerWidth, vh = window.innerHeight;
    const w = fab.offsetWidth, h = fab.offsetHeight;
    const rect = fab.getBoundingClientRect();
    let left = rect.left, top = rect.top;
    left = Math.max(8, Math.min(left, vw - w - 8));
    top = Math.max(8, Math.min(top, vh - h - 8));
    fab.style.left = left + 'px';
    fab.style.top = top + 'px';
  });
})();

document.getElementById('checkoutOrder')?.addEventListener('click', async ()=>{
  if(cart.length === 0){ alert('Кошик порожній'); return; }
  const name = document.getElementById('custName') ? document.getElementById('custName').value.trim() : '';
  const phone = document.getElementById('custPhone') ? document.getElementById('custPhone').value.trim() : '';
  const addr = document.getElementById('custAddr') ? document.getElementById('custAddr').value.trim() : '';
  const note = document.getElementById('custNote') ? document.getElementById('custNote').value.trim() : '';
  const payment = document.querySelector('input[name="payment"]:checked')?.value || 'online';
  if(!name || !phone){
    // если форма не присутствует в UI (мы оформляем прямо из панели) — попросим ввести минимум
    if(!document.getElementById('custName')){
      const n = prompt('Вкажіть ваше ім\'я');
      const ph = prompt('Вкажіть телефон');
      if(!n || !ph){ alert('Потрібні ім\'я та телефон'); return; }
    } else {
      alert("Вкажіть ім'я та телефон"); return;
    }
  }

  const payload = {
    customer: { name, phone, addr, note },
    items: cart.map(c => ({ id: c.id, qty: c.qty, price: c.price })),
    total: cart.reduce((s,x)=> s + x.price * x.qty, 0),
    paymentMethod: payment
  };

  const orderResultEl = document.getElementById('orderResult');
  if(orderResultEl) orderResultEl.textContent = 'Надсилаємо...';

  try {
    const res = await fetch(ORDER_API, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if(!res.ok) throw new Error('Помилка при створенні замовлення на Poster');
    const orderRes = await res.json();
    const orderId = orderRes?.id || orderRes?.orderId || null;

    if(!orderId){
      if(orderResultEl) orderResultEl.textContent = 'Замовлення створено на Poster, але невідомий ID';
      return;
    }

    if(payment === 'cash'){
      if(orderResultEl) orderResultEl.textContent = `Замовлення прийнято №${orderId}`;
      cart = []; saveCart(); updateCartUI();
      setTimeout(()=> closeCartPanel(),1500);
      return;
    }

    if(orderResultEl) orderResultEl.textContent = `Замовлення створено №${orderId}. Онлайн-оплата тимчасово недоступна.`;
    cart = []; saveCart(); updateCartUI();

  } catch(err){
    console.error('checkout error', err);
    if(document.getElementById('orderResult')) document.getElementById('orderResult').textContent = 'Помилка при оформленні замовлення';
  }
});

const catPrev = document.getElementById('catPrev');
const catNext = document.getElementById('catNext');
const tabsTrack = document.getElementById('tabs');

function updateCategoryArrows(){
  if(!tabsTrack || !catPrev || !catNext) return;
  if(tabsTrack.scrollWidth <= tabsTrack.clientWidth + 2){
    catPrev.style.display = 'none';
    catNext.style.display = 'none';
  } else {
    catPrev.style.display = '';
    catNext.style.display = '';
  }
}
catPrev?.addEventListener('click', ()=> { if(tabsTrack) tabsTrack.scrollBy({ left: -240, behavior: 'smooth' }); });
catNext?.addEventListener('click', ()=> { if(tabsTrack) tabsTrack.scrollBy({ left: 240, behavior: 'smooth' }); });
tabsTrack?.addEventListener('wheel', (e)=>{
  if(Math.abs(e.deltaY) > Math.abs(e.deltaX)){
    e.preventDefault();
    tabsTrack.scrollLeft += e.deltaY;
  }
});
window.addEventListener('resize', ()=> setTimeout(updateCategoryArrows, 80));

function showSkeletons(count = 8){
  try{
    const wrap = document.getElementById('products');
    if(!wrap) return;
    wrap.innerHTML = '';
    for(let i=0;i<count;i++){
      const div = document.createElement('div');
      div.className = 'card skeleton';
      div.innerHTML = `<div class="card-img"></div>
        <div class="card-body">
          <div class="card-title"></div>
          <div class="card-desc"></div>
          <div class="card-row">
            <div class="price"></div>
            <div class="add-btn"></div>
          </div>
        </div>`;
      wrap.appendChild(div);
    }
  }catch(e){}
}
showSkeletons();

function renderRandomDishCard(product){
  const container = document.getElementById('randomContainer');
  container.innerHTML = '';
  if(!product){
    container.innerHTML = '<div style="color:var(--muted);padding:12px">Немає доступних товарів для вибору.</div>';
    return;
  }
  const card = document.createElement('div');
  card.className = 'card';
  card.style.maxWidth = '620px';
  card.style.marginTop = '12px';
  card.innerHTML = `
    <img loading="lazy" src="${safeImg(product.img)}" alt="${escapeHtml(product.name)}" class="card-img" />
    <div class="card-body" style="text-align:center">
      <div class="card-title">${escapeHtml(product.name)}</div>
      <div class="card-desc">${escapeHtml(product.desc || '')}</div>
      <div class="card-row" style="justify-content:center">
        <div class="price">${formatUAH(product.price)}</div>
        <div style="display:flex;gap:8px;margin-left:10px">
          <button class="btn add-random">В кошик</button>
          <button class="btn regen-random" style="background:#fff;color:#111;font-weight:700">Ще</button>
        </div>
      </div>
    </div>
  `;
  container.appendChild(card);

  card.querySelector('.add-random').addEventListener('click', ()=>{
    try { addToCartFromProduct(product); } catch(e){ console.error(e); }
    const note = document.getElementById('randomNote');
    if(note){ note.textContent = 'Додано в кошик ✅'; setTimeout(()=> note.textContent = 'Бере випадковий товар із усього меню Poster', 1200); }
  });

  card.querySelector('.regen-random').addEventListener('click', ()=>{
    showRandomDish();
  });
}

function showRandomDish(){
  if(!allProducts || !allProducts.length){
    const container = document.getElementById('randomContainer');
    container.innerHTML = '<div style="padding:12px;color:var(--muted)">Меню ще не завантажено — зачекайте...</div>';
    return;
  }
  const idx = Math.floor(Math.random() * allProducts.length);
  const product = allProducts[idx];
  renderRandomDishCard(product);
}

document.getElementById('randomBtn')?.addEventListener('click', ()=>{
  showRandomDish();
});

updateCategoryArrows();
updateCartUI();
loadMenu();
setTimeout(updateCategoryArrows, 500);
</script>
</body>
</html>
