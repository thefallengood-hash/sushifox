<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Админка — Sushi Fox</title>
  <style>
    body { font-family: system-ui, sans-serif; background:#f8f8f8; margin:0; padding:20px; }
    .card { max-width:1100px; margin:20px auto; background:#fff; padding:18px; border-radius:12px; box-shadow:0 8px 30px rgba(0,0,0,.06) }
    .row { display:flex; gap:8px; align-items:center; }
    input { padding:10px; border-radius:8px; border:1px solid #ddd; }
    button { padding:8px 12px; border-radius:8px; border:none; cursor:pointer; background:#4caf50; color:#fff; font-weight:700 }
    #filters { margin:12px 0 18px 0; display:flex; gap:8px; flex-wrap:wrap; }
    #filters button { background:#eee; color:#000; border-radius:8px; padding:6px 10px; border:none; cursor:pointer }
    #filters button.active { background:#ff5ea8; color:#fff }
    .order { padding:12px; border-radius:10px; border:1px solid #e6e6e6; background:#fff; margin-bottom:10px; }
    .order.new { border:2px solid #ff5ea8; background:#fff6fb; }
    pre { white-space:pre-wrap; margin:6px 0; }
    .actions { margin-top:8px; display:flex; gap:8px; }
    .customer-info { display:none; margin-top:8px; padding:10px; border:1px solid #eee; border-radius:8px; background:#fafafa; font-size:14px; line-height:1.4; }
    .toggle-btn { background:#2196f3; font-size:12px; padding:6px 10px; border-radius:8px; color:#fff; border:none; cursor:pointer }
    .pm-badge { font-weight:700; padding:6px 8px; border-radius:8px; display:inline-block; font-size:13px; }
    .pm-cash { background:#ff9800; color:#fff; }
    .pm-card { background:#4caf50; color:#fff; }
    .pm-other { background:#bdbdbd; color:#fff; }
    .meta { color:#666; font-size:13px; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Админ-панель — Sushi Fox</h1>

    <div id="authBox" class="row" style="margin-bottom:12px;">
      <input id="email" placeholder="admin@example.com" />
      <input id="password" type="password" placeholder="Пароль" />
      <button id="loginBtn">Войти</button>
      <button id="logoutBtn" style="background:#444; display:none; margin-left:8px;">Выйти</button>
      <div id="authMsg" style="margin-left:12px;color:#c00;"></div>
    </div>

    <div id="controls" style="display:none;">
      <div id="filters">
        <button data-filter="all" class="active">Все</button>
        <button data-filter="new">Новые</button>
        <button data-filter="accepted">Принятые</button>
        <button data-filter="cash">Наличка</button>
        <button data-filter="card">Карта</button>
      </div>

      <div style="margin-bottom:8px;">
        <button id="refreshBtn" style="background:#2196f3">Обновить</button>
      </div>

      <div id="ordersWrap"></div>
    </div>
  </div>

  <audio id="notifySound" preload="auto">
    <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
  </audio>

<script type="module">
/* Firebase client SDK */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
import { getFirestore, collection, query, onSnapshot, doc, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

/* Your firebase config */
const firebaseConfig = {
  apiKey: "AIzaSyAYXF7iVTnHIB67DAcoxA5dbhNSEcKrNkA",
  authDomain: "sushi-fox-menu.firebaseapp.com",
  projectId: "sushi-fox-menu",
  storageBucket: "sushi-fox-menu.appspot.com",
  messagingSenderId: "520117298113",
  appId: "1:520117298113:web:608a831f6bbe1e914e0540"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* DOM */
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const authMsg = document.getElementById('authMsg');
const controls = document.getElementById('controls');
const ordersWrap = document.getElementById('ordersWrap');
const notifySound = document.getElementById('notifySound');
let allOrders = [];
let lastSeen = 0;
let currentFilter = 'all';
let unsubscribe = null;

/* Auth handlers */
loginBtn.onclick = async () => {
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value;
  authMsg.textContent = '';
  try { await signInWithEmailAndPassword(auth, email, password); }
  catch (e) { authMsg.textContent = e.message; }
};
logoutBtn.onclick = () => signOut(auth);

onAuthStateChanged(auth, user => {
  if (user) {
    document.getElementById('authBox').style.display = 'none';
    logoutBtn.style.display = 'inline-block';
    controls.style.display = 'block';
    startRealtime();
  } else {
    document.getElementById('authBox').style.display = 'flex';
    logoutBtn.style.display = 'none';
    controls.style.display = 'none';
    stopRealtime();
  }
});

/* --- Helpers --- */

/** normalize payment method: recognizes both "cash" and "Карта" etc. */
function normalizePaymentMethod(raw) {
  const r = (raw ?? '').toString().trim();
  const s = r.toLowerCase();
  if (!s) return { id: 'unknown', label: '' };
  if (s === 'cash' || s.includes('cash')) return { id: 'cash', label: 'Наличка' };
  if (s === 'карта' || s.includes('кар') || s.includes('card') || s.includes('visa') || s.includes('master')) return { id: 'card', label: 'Карта' };
  return { id: 'other', label: r };
}

/** get timestamp ms from various fields */
function extractTs(data) {
  // createdAt may be Firestore Timestamp
  if (data?.createdAt && typeof data.createdAt.toMillis === 'function') return data.createdAt.toMillis();
  if (data?.createdAt && typeof data.createdAt === 'number') return data.createdAt;
  if (data?.date) {
    const t = Date.parse(data.date);
    if (!Number.isNaN(t)) return t;
  }
  // fallback to now
  return Date.now();
}

/** Universal order normalizer */
function normalizeOrder(raw, id) {
  const data = raw || {};
  const orderNumber = data.orderNumber ?? data.orderId ?? data.orderReference ?? '';
  const total = (typeof data.total !== 'undefined') ? data.total : (typeof data.amount !== 'undefined' ? data.amount : '');
  // items/products/cart
  let items = [];
  if (Array.isArray(data.items) && data.items.length) items = data.items;
  else if (Array.isArray(data.products) && data.products.length) items = data.products;
  else if (Array.isArray(data.cart) && data.cart.length) items = data.cart;
  // normalize each item
  items = items.map(p => ({
    name: p?.name || p?.title || p?.productName || '',
    qty: p?.qty ?? p?.quantity ?? p?.count ?? 1,
    price: p?.price ?? p?.unitPrice ?? p?.pricePerUnit ?? 0
  }));

  const customer = data.customer || data.client || {
    name: data.name || '',
    phone: data.phone || '',
    addr: data.addr || data.address || '',
    note: data.note || data.comment || ''
  };

  const pm = normalizePaymentMethod(data.paymentMethod ?? data.payment ?? data.method ?? '');

  let st = (data.status ?? '').toString().toLowerCase();
  let status = 'new';
  if (!st) status = 'new';
  else if (st.includes('нов') || st === 'new' || st.includes('created')) status = 'new';
  else if (st.includes('прин') || st === 'accepted') status = 'accepted';
  else if (st.includes('опл') || st.includes('paid')) status = 'paid';
  else status = st;

  const ts = extractTs(data);

  return {
    id,
    raw: data,
    orderNumber,
    total,
    items,
    customer,
    pmId: pm.id,
    paymentMethodLabel: pm.label,
    status,
    ts
  };
}

/* --- Realtime listening (no orderBy to avoid Firestore errors on missing fields).
     We sort client-side by timestamp so mixed documents are safe.) */
function startRealtime() {
  const q = query(collection(db, 'orders'));
  unsubscribe = onSnapshot(q, snapshot => {
    allOrders = snapshot.docs.map(d => normalizeOrder(d.data(), d.id));
    // sort newest first
    allOrders.sort((a,b) => (b.ts || 0) - (a.ts || 0));
    renderOrders();

    // notify on added
    snapshot.docChanges().forEach(change => {
      if (change.type === 'added') {
        const o = normalizeOrder(change.doc.data(), change.doc.id);
        const num = Number(o.orderNumber) || o.ts || Date.now();
        if (num > lastSeen) { try { notifySound.play(); } catch(e){} lastSeen = num; }
      }
    });
  }, err => console.error('onSnapshot error', err));
}

function stopRealtime() {
  if (unsubscribe) { unsubscribe(); unsubscribe = null; }
  allOrders = [];
  ordersWrap.innerHTML = '';
}

/* --- Rendering with filters (status and payment-method filters) --- */
function renderOrders() {
  ordersWrap.innerHTML = '';
  let list = allOrders.slice();

  if (currentFilter !== 'all') {
    if (currentFilter === 'new' || currentFilter === 'accepted') {
      list = list.filter(o => o.status === currentFilter);
    } else if (currentFilter === 'cash' || currentFilter === 'card') {
      list = list.filter(o => o.pmId === currentFilter);
    }
  }

  if (!list.length) { ordersWrap.innerHTML = '<div style="padding:8px;">Нет заказов</div>'; return; }

  list.forEach(order => {
    const div = document.createElement('div');
    div.className = 'order' + (order.status === 'new' ? ' new' : '');

    // items text
    let itemsText = '';
    (order.items || []).forEach(it => {
      const qty = it.qty ?? 1;
      const price = it.price ?? 0;
      itemsText += `${it.name || '-'} x${qty} = ${price * qty}₴\n`;
    });

    const totalToShow = order.total ?? '';

    // choose badge class
    const pmClass = order.pmId === 'cash' ? 'pm-badge pm-cash' : (order.pmId === 'card' ? 'pm-badge pm-card' : 'pm-badge pm-other');
    const pmLabel = order.paymentMethodLabel || '';

    div.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div>
          <strong>Заказ #${order.orderNumber || order.id}</strong>
          <div class="meta">id: ${order.id} · ${new Date(order.ts).toLocaleString()}</div>
        </div>
        <div style="text-align:right">
          <div style="font-size:16px;"><strong>${totalToShow}₴</strong></div>
          <div style="margin-top:6px;"><span class="${pmClass}">${pmLabel}</span></div>
        </div>
      </div>

      <pre style="margin-top:10px;">${itemsText}</pre>

      <div class="customer-info">
        <strong>Имя:</strong> ${order.customer?.name || '-'}<br>
        <strong>Телефон:</strong> ${order.customer?.phone || '-'}<br>
        <strong>Адрес:</strong> ${order.customer?.addr || '-'}<br>
        <strong>Комментарий:</strong> ${order.customer?.note || '-'}
      </div>
      <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
        <button class="toggle-btn">Развернуть</button>
        <div class="actions"></div>
      </div>
    `;

    const toggleBtn = div.querySelector('.toggle-btn');
    const infoDiv = div.querySelector('.customer-info');
    toggleBtn.onclick = () => {
      if (infoDiv.style.display === 'none' || infoDiv.style.display === '') { infoDiv.style.display = 'block'; toggleBtn.textContent = 'Свернуть'; }
      else { infoDiv.style.display = 'none'; toggleBtn.textContent = 'Развернуть'; }
    };

    const actions = div.querySelector('.actions');
    if (order.status === 'new') {
      const acceptBtn = document.createElement('button');
      acceptBtn.textContent = '✅ Принять';
      acceptBtn.onclick = async () => {
        try { await updateDoc(doc(db, 'orders', order.id), { status: 'accepted' }); }
        catch (e) { alert('Ошибка: ' + e.message); }
      };
      actions.appendChild(acceptBtn);
    }

    const viewBtn = document.createElement('button');
    viewBtn.style.background = '#777';
    viewBtn.style.color = '#fff';
    viewBtn.textContent = '🗂 Просмотр';
    viewBtn.onclick = () => {
      alert(
        `Заказ #${order.orderNumber || order.id}\nСумма: ${totalToShow}₴\n` +
        `Имя: ${order.customer?.name || '-'}\nТелефон: ${order.customer?.phone || '-'}\nАдрес: ${order.customer?.addr || '-'}\nКомментарий: ${order.customer?.note || '-'}\nОплата: ${pmLabel || '-'}`
      );
    };
    actions.appendChild(viewBtn);

    ordersWrap.appendChild(div);
  });
}

/* --- Filters UI binding --- */
document.querySelectorAll('#filters button').forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll('#filters button').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentFilter = btn.dataset.filter;
    renderOrders();
  };
});

/* --- Manual refresh --- */
document.getElementById('refreshBtn').onclick = async () => {
  try {
    const q = query(collection(db, 'orders'));
    const snap = await getDocs(q);
    allOrders = snap.docs.map(d => normalizeOrder(d.data(), d.id));
    allOrders.sort((a,b) => (b.ts || 0) - (a.ts || 0));
    renderOrders();
  } catch (e) {
    alert('Ошибка при обновлении: ' + e.message);
  }
};
</script>
</body>
</html>
