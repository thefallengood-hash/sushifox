<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Админка — Sushi Fox</title>
  <style>
    body { font-family: system-ui, sans-serif; background:#f8f8f8; margin:0; padding:20px; }
    .card { max-width:1000px; margin:20px auto; background:#fff; padding:16px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,.06) }
    .row { display:flex; gap:8px; align-items:center; }
    input { padding:10px; border-radius:8px; border:1px solid #ddd; }
    button { padding:8px 12px; border-radius:8px; border:none; cursor:pointer; background:#4caf50; color:#fff; font-weight:700 }
    #filters { margin:12px 0; display:flex; gap:8px; }
    #filters button { background:#eee; color:#000 }
    #filters button.active { background:#ff5ea8; color:#fff }
    .order { padding:10px; border-radius:8px; border:1px solid #e6e6e6; background:#fff; margin-bottom:10px; }
    .order.new { border:2px solid #ff5ea8; background:#fff6fb; }
    pre { white-space:pre-wrap; margin:6px 0; }
    .actions { margin-top:8px; display:flex; gap:8px; }
    .customer-info { display:none; margin-top:6px; padding:8px; border:1px solid #eee; border-radius:6px; background:#fafafa; font-size:14px; line-height:1.4; }
    .toggle-btn { background:#2196f3; font-size:12px; padding:4px 8px; border-radius:6px; }
    .tag { display:inline-block; padding:2px 8px; border-radius:12px; font-size:12px; background:#eee; color:#333; }
    .tag.cash { background:#ffd8a8; }
    .tag.card { background:#d0f0ff; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Админ-панель — Sushi Fox</h1>

    <div id="authBox" class="row" style="margin-bottom:12px;">
      <input id="email" placeholder="admin@example.com" />
      <input id="password" type="password" placeholder="Пароль" />
      <button id="loginBtn">Войти</button>
      <button id="logoutBtn" style="background:#444; display:none; margin-left:8px;">Выйти</button>
      <div id="authMsg" style="margin-left:12px;color:#c00;"></div>
    </div>

    <div id="controls" style="display:none;">
      <div id="filters">
        <button data-filter="all" class="active">Все</button>
        <button data-filter="new">Новые</button>
        <button data-filter="accepted">Принятые</button>
      </div>
      <div style="margin-bottom:8px;">
        <button id="refreshBtn" style="background:#2196f3">Обновить</button>
      </div>
      <div id="ordersWrap"></div>
    </div>
  </div>

  <audio id="notifySound" preload="auto">
    <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
  </audio>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
import { getFirestore, collection, query, orderBy, onSnapshot, doc, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAYXF7iVTnHIB67DAcoxA5dbhNSEcKrNkA",
  authDomain: "sushi-fox-menu.firebaseapp.com",
  projectId: "sushi-fox-menu",
  storageBucket: "sushi-fox-menu.appspot.com",
  messagingSenderId: "520117298113",
  appId: "1:520117298113:web:608a831f6bbe1e914e0540"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const authMsg = document.getElementById('authMsg');
const controls = document.getElementById('controls');
const ordersWrap = document.getElementById('ordersWrap');
const notifySound = document.getElementById('notifySound');
let allOrders = [];
let lastSeen = 0;
let currentFilter = 'all';
let unsubscribe = null;

loginBtn.onclick = async () => {
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value;
  authMsg.textContent = '';
  try { await signInWithEmailAndPassword(auth, email, password); }
  catch (e) { authMsg.textContent = e.message; }
};

logoutBtn.onclick = () => signOut(auth);

onAuthStateChanged(auth, user => {
  if (user) {
    document.getElementById('authBox').style.display = 'none';
    logoutBtn.style.display = 'inline-block';
    controls.style.display = 'block';
    startRealtime();
  } else {
    document.getElementById('authBox').style.display = 'flex';
    logoutBtn.style.display = 'none';
    controls.style.display = 'none';
    stopRealtime();
  }
});

// helper: определяем читаемую метку оплаты и css-класс
function mapPaymentLabel(raw) {
  const s = (raw || '').toString().toLowerCase();
  if (!s) return { label: '', cls: '' };
  if (s.includes('cash') || s.includes('нал')) return { label: 'Наличка', cls: 'cash' };
  // treat card-like values as "Карта"
  if (s.includes('card') || s.includes('кар') || s.includes('visa') || s.includes('master')) return { label: 'Карта', cls: 'card' };
  // fallback: try to show raw but normalized
  return { label: raw.toString(), cls: '' };
}

// нормализация одного документа
function normalizeDocData(data, id) {
  // номер заказа (поддерживаем разные поля)
  const orderNumber = data.orderNumber || data.orderId || data.orderReference || data.id || '';
  // total
  const total = (typeof data.total !== 'undefined') ? data.total : (typeof data.amount !== 'undefined' ? data.amount : '');
  // items/products
  let items = Array.isArray(data.items) ? data.items.slice() : [];
  const productSources = ['products','cart','orderItems','items','goods'];
  for (const key of productSources) {
    if ((!items || !items.length) && Array.isArray(data[key]) && data[key].length) {
      items = data[key].map(p => ({
        name: p.name || p.title || p.productName || '',
        qty: p.qty ?? p.quantity ?? p.count ?? 1,
        price: p.price ?? p.unitPrice ?? p.pricePerUnit ?? 0
      }));
    }
  }
  // customer
  const customer = data.customer || data.client || {
    name: data.name || data.clientName || '',
    phone: data.phone || data.clientPhone || '',
    addr: data.addr || data.address || data.deliveryAddress || '',
    note: data.note || data.comment || data.customerNote || ''
  };
  // payment method raw + label
  const paymentRaw = (data.paymentMethod || data.payment || data.method || '').toString();
  const paymentInfo = mapPaymentLabel(paymentRaw);
  // status normalization (рус/англ)
  const st = (data.status || '').toString().toLowerCase();
  let normStatus = '';
  if (!st) normStatus = 'new';
  else if (st.includes('нов') || st.includes('created') || st === 'new') normStatus = 'new';
  else if (st.includes('прин') || st === 'accepted') normStatus = 'accepted';
  else if (st.includes('опл') || st.includes('paid')) normStatus = 'paid';
  else normStatus = st;

  return {
    id,
    raw: data,
    orderNumber,
    total,
    items,
    customer,
    paymentRaw,
    paymentLabel: paymentInfo.label,
    paymentClass: paymentInfo.cls,
    status: normStatus
  };
}

function startRealtime() {
  // сортируем по дате/createdAt (если у тебя разные поля, можно менять)
  // использую 'date' как раньше, если не работает можно поменять на 'createdAt'
  const q = query(collection(db, 'orders'), orderBy('date', 'asc'));
  unsubscribe = onSnapshot(q, snapshot => {
    allOrders = snapshot.docs.map(d => normalizeDocData(d.data(), d.id));
    renderOrders();
    snapshot.docChanges().forEach(change => {
      if (change.type === 'added') {
        const o = normalizeDocData(change.doc.data(), change.doc.id);
        // lastSeen сравниваем по number-like или timestamp fallback
        const num = (o.orderNumber && !isNaN(Number(o.orderNumber))) ? Number(o.orderNumber) : Date.now();
        if (num > lastSeen) { try { notifySound.play(); } catch(e){} lastSeen = num; }
      }
    });
  }, err => { console.error('onSnapshot error', err); });
}

function stopRealtime() {
  if (unsubscribe) { unsubscribe(); unsubscribe = null; }
  allOrders = [];
  ordersWrap.innerHTML = '';
}

function renderOrders() {
  ordersWrap.innerHTML = '';
  let list = allOrders.slice();
  if (currentFilter !== 'all') {
    list = list.filter(o => {
      if (!o.status) return false;
      if (currentFilter === 'new') return o.status === 'new';
      if (currentFilter === 'accepted') return o.status === 'accepted';
      return o.status === currentFilter;
    });
  }
  if (!list.length) { ordersWrap.innerHTML = '<div style="padding:8px;">Нет заказов</div>'; return; }

  list.forEach(order => {
    const div = document.createElement('div');
    div.className = 'order' + (order.status === 'new' ? ' new' : '');

    let itemsText = '';
    (order.items || []).forEach(it => {
      const qty = it.qty ?? 1;
      const price = it.price ?? 0;
      itemsText += `${it.name || '-'} x${qty} = ${price * qty}₴\n`;
    });

    const totalToShow = order.total || '';

    // payment label + tag
    const paymentLabel = order.paymentLabel || (order.paymentRaw ? order.paymentRaw : '');
    const tagCls = order.paymentClass ? `tag ${order.paymentClass}` : 'tag';

    div.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div><strong>Заказ #${order.orderNumber}</strong> — ${totalToShow}₴</div>
        <div><span class="${tagCls}">${paymentLabel}</span></div>
      </div>
      <pre>${itemsText}</pre>
      <div class="customer-info">
        <strong>Имя:</strong> ${order.customer?.name || '-'}<br>
        <strong>Телефон:</strong> ${order.customer?.phone || '-'}<br>
        <strong>Адрес:</strong> ${order.customer?.addr || '-'}<br>
        <strong>Комментарий:</strong> ${order.customer?.note || '-'}
      </div>
      <button class="toggle-btn">Развернуть</button>
      <div class="actions"></div>
    `;

    const toggleBtn = div.querySelector('.toggle-btn');
    const infoDiv = div.querySelector('.customer-info');
    toggleBtn.onclick = () => {
      if (infoDiv.style.display === 'none') { infoDiv.style.display = 'block'; toggleBtn.textContent = 'Свернуть'; }
      else { infoDiv.style.display = 'none'; toggleBtn.textContent = 'Развернуть'; }
    };

    const actions = div.querySelector('.actions');
    if (order.status === 'new') {
      const acceptBtn = document.createElement('button');
      acceptBtn.textContent = '✅ Принять';
      acceptBtn.onclick = async () => {
        try { await updateDoc(doc(db, 'orders', order.id), { status: 'accepted' }); }
        catch (e) { alert('Ошибка: ' + e.message); }
      };
      actions.appendChild(acceptBtn);
    }

    const viewBtn = document.createElement('button');
    viewBtn.style.background = '#777';
    viewBtn.textContent = '🗂 Просмотр';
    viewBtn.onclick = () => {
      alert(
        `Заказ #${order.orderNumber}\nСумма: ${totalToShow}₴\n` +
        `Имя: ${order.customer?.name || '-'}\nТелефон: ${order.customer?.phone || '-'}\nАдрес: ${order.customer?.addr || '-'}\nКомментарий: ${order.customer?.note || '-'}`
      );
    };
    actions.appendChild(viewBtn);

    ordersWrap.appendChild(div);
  });
}

// фильтры
document.querySelectorAll('#filters button').forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll('#filters button').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentFilter = btn.dataset.filter;
    renderOrders();
  };
});

// ручной рефреш
document.getElementById('refreshBtn').onclick = async () => {
  try {
    const snap = await getDocs(query(collection(db, 'orders'), orderBy('date', 'asc')));
    allOrders = snap.docs.map(d => normalizeDocData(d.data(), d.id));
    renderOrders();
  } catch (e) { alert('Ошибка при обновлении: ' + e.message); }
};
</script>
</body>
</html>
