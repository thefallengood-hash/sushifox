<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ê–¥–º–∏–Ω–∫–∞ ‚Äî Sushi Fox</title>
  <style>
    body { font-family: system-ui, sans-serif; background:#f8f8f8; margin:0; padding:20px; }
    .card { max-width:1000px; margin:20px auto; background:#fff; padding:16px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,.06) }
    .row { display:flex; gap:8px; align-items:center; }
    input { padding:10px; border-radius:8px; border:1px solid #ddd; }
    button { padding:8px 12px; border-radius:8px; border:none; cursor:pointer; background:#4caf50; color:#fff; font-weight:700 }
    #filters { margin:12px 0; display:flex; gap:8px; }
    #filters button { background:#eee; color:#000 }
    #filters button.active { background:#ff5ea8; color:#fff }
    .order { padding:10px; border-radius:8px; border:1px solid #e6e6e6; background:#fff; margin-bottom:10px; }
    .order.new { border:2px solid #ff5ea8; background:#fff6fb; }
    pre { white-space:pre-wrap; margin:6px 0; }
    .actions { margin-top:8px; display:flex; gap:8px; }
    .customer-info { display:none; margin-top:6px; padding:8px; border:1px solid #eee; border-radius:6px; background:#fafafa; font-size:14px; line-height:1.4; }
    .toggle-btn { background:#2196f3; font-size:12px; padding:4px 8px; border-radius:6px; }
  </style>
</head>
<body>
  <div class="card">
    <h1>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å ‚Äî Sushi Fox</h1>

    <div id="authBox" class="row" style="margin-bottom:12px;">
      <input id="email" placeholder="admin@example.com" />
      <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å" />
      <button id="loginBtn">–í–æ–π—Ç–∏</button>
      <button id="logoutBtn" style="background:#444; display:none; margin-left:8px;">–í—ã–π—Ç–∏</button>
      <div id="authMsg" style="margin-left:12px;color:#c00;"></div>
    </div>

    <div id="controls" style="display:none;">
      <div id="filters">
        <button data-filter="all" class="active">–í—Å–µ</button>
        <button data-filter="new">–ù–æ–≤—ã–µ</button>
        <button data-filter="accepted">–ü—Ä–∏–Ω—è—Ç—ã–µ</button>
      </div>
      <div style="margin-bottom:8px;">
        <button id="refreshBtn" style="background:#2196f3">–û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>
      <div id="ordersWrap"></div>
    </div>
  </div>

  <audio id="notifySound" preload="auto">
    <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
  </audio>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
import { getFirestore, collection, query, orderBy, onSnapshot, doc, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAYXF7iVTnHIB67DAcoxA5dbhNSEcKrNkA",
  authDomain: "sushi-fox-menu.firebaseapp.com",
  projectId: "sushi-fox-menu",
  storageBucket: "sushi-fox-menu.appspot.com",
  messagingSenderId: "520117298113",
  appId: "1:520117298113:web:608a831f6bbe1e914e0540"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const authMsg = document.getElementById('authMsg');
const controls = document.getElementById('controls');
const ordersWrap = document.getElementById('ordersWrap');
const notifySound = document.getElementById('notifySound');
let allOrders = [];
let lastSeen = 0;
let currentFilter = 'all';
let unsubscribe = null;

loginBtn.onclick = async () => {
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value;
  authMsg.textContent = '';
  try { await signInWithEmailAndPassword(auth, email, password); }
  catch (e) { authMsg.textContent = e.message; }
};

logoutBtn.onclick = () => signOut(auth);

onAuthStateChanged(auth, user => {
  if (user) {
    document.getElementById('authBox').style.display = 'none';
    logoutBtn.style.display = 'inline-block';
    controls.style.display = 'block';
    startRealtime();
  } else {
    document.getElementById('authBox').style.display = 'flex';
    logoutBtn.style.display = 'none';
    controls.style.display = 'none';
    stopRealtime();
  }
});

function startRealtime() {
  const q = query(collection(db, 'orders'), orderBy('date', 'asc'));
  unsubscribe = onSnapshot(q, snapshot => {
    allOrders = snapshot.docs.map(d => {
      const data = d.data();
      // –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª–µ–π
      if (!data.orderNumber) data.orderNumber = data.orderId || data.orderReference || '';
      if (!data.total) data.total = data.amount || 0;
      if (!data.items && data.products) data.items = data.products.map(p => ({
        name: p.name,
        qty: p.qty,
        price: p.price || 0
      }));
      if (data.status === "–ù–æ–≤—ã–π") data.status = 'new';
      if (data.status === "–ü—Ä–∏–Ω—è—Ç—ã–µ") data.status = 'accepted';
      return { id: d.id, ...data };
    });
    renderOrders();
    snapshot.docChanges().forEach(change => {
      if (change.type === 'added') {
        const o = change.doc.data();
        let num = o.orderNumber || o.orderId || o.orderReference || 0;
        if (num > lastSeen) { try { notifySound.play(); } catch(e){} lastSeen = num; }
      }
    });
  });
}

function stopRealtime() {
  if (unsubscribe) { unsubscribe(); unsubscribe = null; }
  allOrders = [];
  ordersWrap.innerHTML = '';
}

function renderOrders() {
  ordersWrap.innerHTML = '';
  let list = allOrders;
  if (currentFilter !== 'all') list = list.filter(o => o.status === currentFilter);
  if (!list.length) { ordersWrap.innerHTML = '<div style="padding:8px;">–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤</div>'; return; }

  list.forEach(order => {
    const div = document.createElement('div');
    div.className = 'order' + (order.status === 'new' ? ' new' : '');
    let items = '';
    (order.items || []).forEach(it => items += `${it.name} x${it.qty} = ${it.price * it.qty}‚Ç¥\n`);
    div.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div><strong>–ó–∞–∫–∞–∑ #${order.orderNumber}</strong> ‚Äî ${order.total}‚Ç¥</div>
        <div><small>${order.paymentMethod || ''}</small></div>
      </div>
      <pre>${items}</pre>
      <div class="customer-info">
        <strong>–ò–º—è:</strong> ${order.customer?.name || '-'}<br>
        <strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${order.customer?.phone || '-'}<br>
        <strong>–ê–¥—Ä–µ—Å:</strong> ${order.customer?.addr || '-'}<br>
        <strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> ${order.customer?.note || '-'}
      </div>
      <button class="toggle-btn">–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å</button>
      <div class="actions"></div>
    `;
    const toggleBtn = div.querySelector('.toggle-btn');
    const infoDiv = div.querySelector('.customer-info');
    toggleBtn.onclick = () => {
      if (infoDiv.style.display === 'none') { infoDiv.style.display = 'block'; toggleBtn.textContent = '–°–≤–µ—Ä–Ω—É—Ç—å'; }
      else { infoDiv.style.display = 'none'; toggleBtn.textContent = '–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å'; }
    };
    const actions = div.querySelector('.actions');
    if (order.status === 'new') {
      const acceptBtn = document.createElement('button');
      acceptBtn.textContent = '‚úÖ –ü—Ä–∏–Ω—è—Ç—å';
      acceptBtn.onclick = async () => { try { await updateDoc(doc(db, 'orders', order.id), { status: 'accepted' }); } catch(e){ alert('–û—à–∏–±–∫–∞: '+e.message); } };
      actions.appendChild(acceptBtn);
    }
    const viewBtn = document.createElement('button');
    viewBtn.style.background = '#777';
    viewBtn.textContent = 'üóÇ –ü—Ä–æ—Å–º–æ—Ç—Ä';
    viewBtn.onclick = () => { alert(
      `–ó–∞–∫–∞–∑ #${order.orderNumber}\n–°—É–º–º–∞: ${order.total}‚Ç¥\n` +
      `–ò–º—è: ${order.customer?.name}\n–¢–µ–ª–µ—Ñ–æ–Ω: ${order.customer?.phone}\n–ê–¥—Ä–µ—Å: ${order.customer?.addr}\n–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${order.customer?.note}`
    ); };
    actions.appendChild(viewBtn);
    ordersWrap.appendChild(div);
  });
}

document.querySelectorAll('#filters button').forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll('#filters button').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentFilter = btn.dataset.filter;
    renderOrders();
  };
});

document.getElementById('refreshBtn').onclick = async () => {
  try {
    const snap = await getDocs(query(collection(db, 'orders'), orderBy('date', 'asc')));
    allOrders = snap.docs.map(d => {
      const data = d.data();
      if (!data.orderNumber) data.orderNumber = data.orderId || data.orderReference || '';
      if (!data.total) data.total = data.amount || 0;
      if (!data.items && data.products) data.items = data.products.map(p => ({ name:p.name, qty:p.qty, price:p.price||0 }));
      if (data.status === "–ù–æ–≤—ã–π") data.status = 'new';
      if (data.status === "–ü—Ä–∏–Ω—è—Ç—ã–µ") data.status = 'accepted';
      return { id:d.id, ...data };
    });
    renderOrders();
  } catch (e) { alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏: ' + e.message); }
};
</script>
</body>
</html>
